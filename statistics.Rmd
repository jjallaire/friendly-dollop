---
title: "Statistics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("setup.R")
```

## Reduce full dataset

```{r}
data.priming.reduced <- data.priming %>% 
  select(-one_of(removes$amoA))
```


## Do treatments have a significant effect on community composition?

```{r}
X <- data.priming.reduced %>% 
  select(-c(amoA.001:amoA.074))
Y <- data.priming.reduced %>% 
  select(amoA.001:amoA.074)

adonis(Y ~ X$fert_level + X$addition + X$crop + X$timepoint) 
```

Looks like fertilization level (and to a lesser extent, crop) significantly impacts community composition.

## Gene-wise anova

First pivot dataset to long format:

```{r}
data.priming.reduced.long <- data.priming.reduced %>% 
  select(-sample_id, field_rep) %>% 
  pivot_longer(cols = amoA.001:amoA.074) 
```

Create an ANOVA formula for each gene against all the factors. Borrowed heavily from [Kevin Blighe on this BioStars post](https://www.biostars.org/p/295214/#295266)

```{r}
formulae <- lapply(colnames(data.priming.reduced %>% select(amoA.001:amoA.074)), function(x) as.formula(paste0(x, " ~ fert_level * crop * timepoint * addition")))

res <- lapply(formulae, function(x) broom::tidy(aov(x, data = data.priming.reduced)))
names(res) <- format(formulae)
names(res) <- str_sub(names(res), end = 8)

anova_results <- lapply(seq_along(res), function(i) res[[i]] %>% mutate(gene = names(res)[[i]])) %>% 
  bind_rows() %>% 
  filter(term != "Residuals")
```

We can then visualize the anova results in a heatmap. Here, each column represents a gene, the rows represent the factors being tested by the ANOVA, and the colors indicate the significance of the ANOVA test. 

```{r}
anova_results %>% 
  mutate(sig = case_when(
    p.value < 0.5 & p.value > 0.1 ~ "*",
    p.value < 0.1 & p.value > 0.01 ~ "**",
    p.value < 0.01 ~ "***",
    TRUE ~ "NS"
  )) %>% 
  mutate(gene = str_sub(gene, -3)) %>% 
  ggplot(aes(gene, term, fill = sig)) + 
  geom_tile(color = "black") + 
  coord_equal() + 
  labs(y = "",
       x = "amoA",
       title = "Summary of ANOVA results",
       fill = "Significance ") + 
  theme(
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)
  ) + 
  scale_fill_viridis_d(option = "magma", direction = -1)
```

